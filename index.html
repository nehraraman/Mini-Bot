<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Mini App - X Reward Bot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:12px}
    .card{border:1px solid #ddd;padding:10px;margin-bottom:10px;border-radius:8px}
    button{padding:8px 12px;border-radius:6px}
    img.preview{max-width:200px;display:block;margin-top:8px}
  </style>
</head>
<body>
  <h2>X Reward Mini App</h2>
  <div id="status" class="card">Loading...</div>

  <div id="usercard" class="card" style="display:none">
    <div><strong id="uname"></strong> (<span id="uid"></span>)</div>
    <div>Coins: <span id="coins">0</span></div>
    <div><a id="ref" href="#" target="_blank">Referral</a></div>
    <div id="adminNote" style="color:green;display:none"><strong>Admin mode</strong></div>
  </div>

  <div id="ads" class="card">
    <h4>Watch Ad (options)</h4>
    <div>
      <button id="btnOffer">Get Ad Offer (recommended)</button>
      <button id="btnWatched">I've watched an ad (quick claim)</button>
      <div id="adStatus"></div>
    </div>
  </div>

  <div id="tasks" class="card">
    <h4>Tasks</h4>
    <div id="tasksList">Loading tasks...</div>
  </div>

  <div id="submit" class="card">
    <h4>Submit Proof</h4>
    <form id="proofForm">
      Task ID: <input id="taskId" name="task_id" required /><br/><br/>
      Choose image: <input id="fileInput" type="file" accept="image/*" required /><br/>
      <img id="preview" class="preview" style="display:none"/><br/>
      <button type="submit">Submit Proof</button>
    </form>
    <div id="submitResult"></div>
  </div>

  <div id="mySubs" class="card">
    <h4>My Submissions</h4>
    <div id="subsList">Loading...</div>
  </div>

  <div id="adminPanel" class="card" style="display:none">
    <h4>Admin — Pending Submissions</h4>
    <div id="pendingList">Loading...</div>
  </div>

<script>
let initData = null;
async function init(){
  document.getElementById('status').innerText = "Initializing...";
  // Telegram WebApp init_data is normally provided via window.Telegram.WebApp.initData
  // For testing, allow manual paste in prompt:
  if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData){
    initData = Telegram.WebApp.initData;
  } else {
    // dev prompt
    if(!initData){
      initData = prompt("Paste init_data for testing (or press Cancel to continue as guest):") || "";
    }
  }
  if(!initData){
    document.getElementById('status').innerText = "No init_data provided. Use testing init_data or open via Telegram WebApp.";
    return;
  }
  // fetch /webapp/me
  const r = await fetch('/webapp/me', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({init_data: initData})});
  const j = await r.json();
  if(!j.ok){ document.getElementById('status').innerText = "Auth failed: "+(j.detail||JSON.stringify(j)); return; }
  document.getElementById('status').innerText = "Ready";
  document.getElementById('usercard').style.display='block';
  document.getElementById('uname').innerText = j.username || 'User';
  document.getElementById('uid').innerText = (j.referral_link||'').split('start=')[1]||'';
  document.getElementById('coins').innerText = j.coins;
  document.getElementById('ref').href = j.referral_link;
  if(j.is_admin) document.getElementById('adminPanel').style.display='block';
  // load tasks and submissions
  loadTasks();
  loadSubs();
  if(j.is_admin) loadPending();
}

// tasks
async function loadTasks(){
  const r = await fetch('/webapp/get_tasks');
  const j = await r.json();
  const el = document.getElementById('tasksList');
  if(!j.ok){ el.innerText = "Error loading tasks"; return; }
  el.innerHTML = '';
  j.tasks.forEach(t=>{
    const d = document.createElement('div');
    d.innerHTML = `<strong>${t.title}</strong> (Reward: ${t.reward})<br/>${t.description}<br/>Link: <a href="${t.link}" target="_blank">${t.link}</a><br/>Task ID: ${t.task_id}<hr/>`;
    el.appendChild(d);
  });
}

// ad flow: get offer -> mock show -> verify
document.getElementById('btnOffer').addEventListener('click', async ()=>{
  document.getElementById('adStatus').innerText = "Requesting ad offer...";
  const r = await fetch('/webapp/ad_offer', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({init_data: initData})});
  const j = await r.json();
  if(!j.ok){ document.getElementById('adStatus').innerText = "Ad offer failed"; return; }
  document.getElementById('adStatus').innerText = `Got ad id ${j.ad_id}. Showing mock ad...`;
  // Mock ad: wait 3 seconds to simulate ad
  await new Promise(res=>setTimeout(res,3000));
  document.getElementById('adStatus').innerText = "Ad finished. Verifying...";
  // Create a fake receipt token and call verify_ad
  const receipt = "mock_receipt_"+Date.now();
  const v = await fetch('/webapp/verify_ad', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({init_data: initData, ad_receipt: receipt})});
  const vk = await v.json();
  if(vk.ok){
    document.getElementById('adStatus').innerText = `Ad verified. Awarded ${vk.coins_awarded} coins. Total: ${vk.coins_total}`;
    document.getElementById('coins').innerText = vk.coins_total;
  } else {
    document.getElementById('adStatus').innerText = "Ad verification failed";
  }
});

// quick claim (existing flow)
document.getElementById('btnWatched').addEventListener('click', async ()=>{
  document.getElementById('adStatus').innerText = "Claiming ad watched...";
  const r = await fetch('/webapp/ad_watched', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({init_data: initData})});
  const j = await r.json();
  if(j.ok){
    document.getElementById('adStatus').innerText = `Awarded ${j.coins_awarded}. Total: ${j.coins_total}`;
    document.getElementById('coins').innerText = j.coins_total;
  } else {
    document.getElementById('adStatus').innerText = "Claim failed: " + (j.error||JSON.stringify(j));
  }
});

// submit proof
document.getElementById('fileInput').addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const p = document.getElementById('preview');
  p.src = URL.createObjectURL(f);
  p.style.display = 'block';
});
document.getElementById('proofForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const task_id = document.getElementById('taskId').value;
  const file = document.getElementById('fileInput').files[0];
  if(!task_id || !file){ alert('Provide Task ID and file'); return; }
  const fd = new FormData();
  fd.append('init_data', initData);
  fd.append('task_id', task_id);
  fd.append('file', file);
  const r = await fetch('/webapp/submit_proof', {method:'POST', body: fd});
  const j = await r.json();
  document.getElementById('submitResult').innerText = JSON.stringify(j);
  loadSubs();
  if(document.getElementById('adminPanel').style.display!='none') loadPending();
});

// my submissions
async function loadSubs(){
  const r = await fetch('/webapp/my_submissions', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({init_data: initData})});
  const j = await r.json();
  const el = document.getElementById('subsList'); el.innerHTML = '';
  if(!j.ok){ el.innerText = "Error"; return; }
  j.submissions.forEach(s=>{
    const d = document.createElement('div');
    d.innerHTML = `Task ${s.task_id} — ${s.status} — ${s.submitted_at} <br/>` + (s.file_url?`<a href="${s.file_url}" target="_blank">View Proof</a>`:"");
    el.appendChild(d);
  });
}

// admin: load pending and review
async function loadPending(){
  const r = await fetch('/webapp/pending_submissions', {method:'GET', headers:{'Content-Type':'application/json'}, body: JSON.stringify({init_data: initData})});
  const j = await r.json();
  const el = document.getElementById('pendingList'); el.innerHTML = '';
  if(!j.ok){ el.innerText = "Error loading pending"; return; }
  if(j.pending.length==0){ el.innerText = "No pending submissions."; return; }
  j.pending.forEach(item=>{
    const d = document.createElement('div');
    d.innerHTML = `#${item.submission_id} — User: ${item.username} (${item.user_id}) — Task ${item.task_id} — ${item.submitted_at} <br/>` +
      (item.file_url?`<a href="${item.file_url}" target="_blank">View</a>`:"") +
      `<br/><button onclick="review(${item.submission_id},'approve')">Approve</button> <button onclick="review(${item.submission_id},'reject')">Reject</button><hr/>`;
    el.appendChild(d);
  });
}

async function review(submission_id, action){
  const reason = prompt("Optional reason (for reject or note):") || "";
  const r = await fetch('/webapp/review_submission', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({init_data: initData, submission_id: submission_id, action: action, reason: reason})});
  const j = await r.json();
  alert(JSON.stringify(j));
  loadPending(); loadSubs();
}

// init on load
window.addEventListener('load', init);
</script>
</body>
</html>
