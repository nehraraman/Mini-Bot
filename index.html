<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>X_Reward_Bot — Mini App</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:16px;background:#f7f7fb;color:#111}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    button{padding:8px 12px;border-radius:8px;border:0;background:#0066ff;color:#fff;cursor:pointer}
    .muted{color:#666;font-size:13px}
    .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.06);margin-bottom:10px}
    input,select{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%}
    .row{display:flex;gap:8px}
    .small{font-size:13px}
    img.preview{max-width:200px;border-radius:8px;display:block;margin-top:8px}
    .error{color:#b00020}
    .success{color:#007a3d}
  </style>
</head>
<body>
  <header>
    <h2>X Reward — Mini App</h2>
    <div>
      <button id="openTelegramBtn" style="display:none">Open in Telegram</button>
    </div>
  </header>

  <div id="status" class="muted card">Initializing…</div>

  <div id="userCard" class="card" style="display:none">
    <div><strong id="userName">User</strong> — <span id="userId" class="muted"></span></div>
    <div style="margin-top:8px">Coins: <strong id="coins">0</strong></div>
    <div class="muted small" id="boostInfo"></div>
  </div>

  <div id="actions" style="display:none">
    <div class="card">
      <h3 class="small">Tasks</h3>
      <div id="tasksList" class="small">Loading tasks…</div>
    </div>

    <div class="card">
      <h3 class="small">Quick Actions</h3>
      <div style="display:grid;gap:8px">
        <button id="btnAd">I've watched an ad (claim)</button>
        <button id="btnDaily">Claim Daily Reward</button>
        <button id="btnLeaderboard">Show Leaderboard</button>
      </div>
      <div id="actionMsg" class="muted small" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3 class="small">Submit Proof (image)</h3>
      <form id="proofForm">
        <label>Task ID</label>
        <input type="number" id="taskIdInput" required />
        <label style="margin-top:6px">Choose image</label>
        <input type="file" id="proofFile" accept="image/*" required />
        <img id="preview" class="preview" style="display:none"/>
        <div style="margin-top:8px">
          <button type="submit">Submit Proof</button>
        </div>
        <div id="submitMsg" class="muted small" style="margin-top:8px"></div>
      </form>
    </div>

    <div id="leaderboardCard" class="card" style="display:none">
      <h3 class="small">Leaderboard</h3>
      <div id="leaderboardList" class="small">Loading…</div>
    </div>

  </div>

<script>
/*
  Robust client for the WebApp:
  - Reads init_data from Telegram WebApp if present
  - Falls back to URL param "init_data"
  - Calls /webapp/me, /webapp/get_tasks, /webapp/check_join, /webapp/ad_watched, /webapp/submit_proof, /webapp/daily_claim, /webapp/leaderboard
  - Graceful error handling and user messages
*/

const STATUS = document.getElementById('status');
const userCard = document.getElementById('userCard');
const actions = document.getElementById('actions');
const userNameEl = document.getElementById('userName');
const userIdEl = document.getElementById('userId');
const coinsEl = document.getElementById('coins');
const boostInfo = document.getElementById('boostInfo');
const tasksList = document.getElementById('tasksList');
const actionMsg = document.getElementById('actionMsg');
const previewImg = document.getElementById('preview');
const submitMsg = document.getElementById('submitMsg');
const leaderboardCard = document.getElementById('leaderboardCard');
const leaderboardList = document.getElementById('leaderboardList');

function setStatus(text, isError){
  STATUS.textContent = text;
  STATUS.className = isError ? 'card error' : 'card muted';
}

// Read init_data: support Telegram WebApp variable and URL param "init_data"
function readInitData(){
  try{
    const tg = window.Telegram && window.Telegram.WebApp;
    if(tg && tg.initData){
      return tg.initData;
    }
  }catch(e){}
  // fallback: try URL param 'init_data' or 'tgWebAppInitData'
  try{
    const u = new URL(window.location.href);
    return u.searchParams.get('init_data') || u.searchParams.get('tgWebAppInitData') || null;
  }catch(e){
    return null;
  }
}

const initData = readInitData();

if(!initData){
  setStatus('No Telegram init data detected. Open this page as a Telegram WebApp (from your bot).', true);
} else {
  setStatus('Init data detected. Verifying with server…');
  initialize();
}

async function initialize(){
  try{
    // call /webapp/me
    const res = await fetch('/webapp/me', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({init_data: initData})
    });
    if(!res.ok){
      const err = await res.json().catch(()=>({detail:'unknown'}));
      setStatus('Server verification failed: ' + (err.detail || JSON.stringify(err)), true);
      return;
    }
    const data = await res.json();
    if(!data.ok){
      setStatus('Server response not OK: ' + JSON.stringify(data), true);
      return;
    }
    // fetch user info from init_data as well (if Telegram provided user)
    let userName = 'User';
    try{
      const parsed = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) || null;
      if(parsed && parsed.user){
        userName = parsed.user.username || parsed.user.first_name || userName;
        userIdEl.textContent = 'ID: ' + parsed.user.id;
      }
    }catch(e){}
    userNameEl.textContent = userName;
    coinsEl.textContent = data.coins || 0;
    if(data.boost_until){
      boostInfo.textContent = 'Boost active until: ' + data.boost_until;
    } else {
      boostInfo.textContent = '';
    }
    userCard.style.display = 'block';
    actions.style.display = 'block';
    setStatus('Loaded — you can interact with the Mini App.');
    await loadTasks();
  }catch(err){
    console.error(err);
    setStatus('Initialization error: ' + (err.message || err), true);
  }
}

async function loadTasks(){
  tasksList.textContent = 'Loading tasks…';
  try{
    const r = await fetch('/webapp/get_tasks?page=1&per_page=20');
    const j = await r.json();
    if(!j.ok){
      tasksList.textContent = 'Could not load tasks.';
      return;
    }
    if(j.tasks.length===0){
      tasksList.textContent = 'No tasks available.';
      return;
    }
    tasksList.innerHTML = '';
    j.tasks.forEach(t=>{
      const d = document.createElement('div');
      d.className = 'small';
      d.innerHTML = `<strong>(${t.task_id}) ${escapeHtml(t.title)}</strong><div class="muted small">${escapeHtml(t.description)}</div>
      <div style="margin-top:6px">Reward: <strong>${t.reward}</strong> — <a href="${escapeAttr(t.link)}" target="_blank">Open link</a></div>`;
      tasksList.appendChild(d);
    });
  }catch(e){
    console.error(e);
    tasksList.textContent = 'Error loading tasks.';
  }
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m];});}
function escapeAttr(s){ return (s||'').replace(/"/g, '%22'); }

// Ad watched
document.getElementById('btnAd').addEventListener('click', async ()=>{
  actionMsg.textContent = 'Claiming ad reward…';
  try{
    const r = await fetch('/webapp/ad_watched', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({init_data: initData})
    });
    const j = await r.json();
    if(!j.ok){
      actionMsg.textContent = 'Error: ' + (j.error || JSON.stringify(j));
      return;
    }
    coinsEl.textContent = j.coins_total;
    actionMsg.textContent = 'Awarded ' + j.coins_awarded + ' coins. Total: ' + j.coins_total;
  }catch(e){
    console.error(e);
    actionMsg.textContent = 'Network error while claiming ad.';
  }
});

// Daily claim
document.getElementById('btnDaily').addEventListener('click', async ()=>{
  actionMsg.textContent = 'Claiming daily reward…';
  try{
    const r = await fetch('/webapp/daily_claim', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({init_data: initData})
    });
    const j = await r.json();
    if(!j.ok){
      actionMsg.textContent = 'Could not claim: ' + (j.msg || JSON.stringify(j));
      return;
    }
    coinsEl.textContent = j.coins_total;
    actionMsg.textContent = 'Daily claimed: +' + j.coins_awarded + ' coins.';
  }catch(e){
    actionMsg.textContent = 'Network error while claiming daily.';
  }
});

// Leaderboard
document.getElementById('btnLeaderboard').addEventListener('click', async ()=>{
  leaderboardCard.style.display = 'block';
  leaderboardList.textContent = 'Loading…';
  try{
    const r = await fetch('/webapp/leaderboard?page=1&per_page=20');
    const j = await r.json();
    if(!j.ok){ leaderboardList.textContent = 'Failed to load.'; return; }
    leaderboardList.innerHTML = '';
    j.leaderboard.forEach((p,idx)=>{
      const el = document.createElement('div');
      el.textContent = `${idx+1}. ${p.username || 'user'+p.user_id} — ${p.coins} coins`;
      leaderboardList.appendChild(el);
    });
  }catch(e){
    leaderboardList.textContent = 'Error loading leaderboard.';
  }
});

// Submit proof form
document.getElementById('proofFile').addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f){ previewImg.style.display='none'; return; }
  const url = URL.createObjectURL(f);
  previewImg.src = url; previewImg.style.display='block';
});

document.getElementById('proofForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  submitMsg.textContent = 'Uploading proof…';
  const fileInput = document.getElementById('proofFile');
  const taskId = document.getElementById('taskIdInput').value;
  if(!fileInput.files[0]){ submitMsg.textContent = 'Please choose an image.'; return; }
  const fd = new FormData();
  fd.append('init_data', initData);
  fd.append('task_id', taskId);
  fd.append('file', fileInput.files[0]);
  try{
    const r = await fetch('/webapp/submit_proof', {method:'POST', body: fd});
    const j = await r.json();
    if(!j.ok){ submitMsg.textContent = 'Upload failed: ' + (j.detail || JSON.stringify(j)); return; }
    submitMsg.textContent = j.msg || 'Submitted.';
  }catch(e){
    console.error(e);
    submitMsg.textContent = 'Network error during submit.';
  }
});

</script>
</body>
</html>
